<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GCP ping</title>
  <link href='https://fonts.googleapis.com/css?family=Oxygen:700' rel='stylesheet' type='text/css'>
<style>
body, input {
  font-family: 'Oxygen', sans-serif;
}

#container {
  width: 600px;
  margin: auto;
}

td {
  padding: 10px;
  text-align: center;
}

td.result {
  width: 100px;
  text-align: right;
  font-family: monospace;
}

table, td {
  border: 1px solid black;
}

tr#allrow td {
  border: 0;
}
</style>
</head>
<body>
  <div id="container">
  <h1>Measure ping time to <a href="https://cloud.google.com/compute/docs/regions-zones/regions-zones">GCE regions</a></h1>
  <table>
    <tr>
      <td>us-central1</td>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/council-bluffs/">Central US</a></td>
      <td><button class="ping" id="us-central1">HTTP ping</button></td>
      <td class="result" id="us-central1-result">&nbsp;</td>
    </tr>
    <tr>
      <td>us-east1</td>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/berkeley-county/">Eastern US</a></td>
      <td><button class="ping" id="us-east1">HTTP ping</button></td>
      <td class="result" id="us-east1-result">&nbsp;</td>
    </tr>
    <tr>
      <td>us-west1</td>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/the-dalles/">Western US</a></td>
      <td><button class="ping" id="us-west1">HTTP ping</button></td>
      <td class="result" id="us-west1-result">&nbsp;</td>
    </tr>
    <tr>
      <td>europe-west1</td>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/st-ghislain/">Western Europe</a></td>
      <td><button class="ping" id="europe-west1">HTTP ping</button></td>
      <td class="result" id="europe-west1-result">&nbsp;</td>
    </tr>
    <tr>
      <td>asia-east1</td>
      <td><a href="https://www.google.com/about/datacenters/inside/locations/changhua-county/">Eastern Asia</a></td>
      <td><button class="ping" id="asia-east1">HTTP ping</button></td>
      <td class="result" id="asia-east1-result">&nbsp;</td>
    </tr>
    <tr>
      <td>asia-northeast1</td>
      <td>Northeastern Asia</td>
      <td><button class="ping" id="asia-northeast1">HTTP ping</button></td>
      <td class="result" id="asia-northeast1-result">&nbsp;</td>
    </tr>
    <tr id="allrow"><td /><td /><td id="allcell"><button id="all">All regions</button></td></tr>
  </table>
  </div>
</body>
<script type="text/javascript">
// TODO: Don't block XHR requests, but execute them in sequence.
// TODO: Clear results column when rerunning a ping.
// TODO: Highlight fastest/closest region.
// TODO: Show regions on a map, with lines overlayed according to ping times.
// TODO: Add an option to contribute times and JS geolocation info to a public BigQuery dataset.

let _TIMES = 5; // Number of times to ping, taking the average.

function ping(region, cb) {
  let times = [];
  for (let i = 0; i < _TIMES; i++) {
    let start = new Date().getTime();
    let xhr = new XMLHttpRequest();
    let url = 'https://storage.googleapis.com/gcping-'+region+'/ping';
    xhr.open('GET', url, false); // async=false
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.onreadystatechange = function() {
      let took = new Date().getTime()-start;
      if (xhr.readyState != 4) { return; }
      if (xhr.status >= 400) {
        console.error(xhr);
        cb({'error': true});
        return;
      }
	  times.push(took);
    };

    try {
      xhr.send('');
    } catch (e) {
      console.error(e);
      cb({'error': true});
      return;
    }
  }
  cb({'took':avg(times)});
}

function avg(arr) {
  let sum = 0;
  arr.forEach(function(x) { sum += x });
  return sum / arr.length;
}

let buttons = document.getElementsByClassName('ping');
for (let i = 0; i < buttons.length; i++) {
  let b = buttons[i];
  buttons[i].onclick = function() {
    let out = document.getElementById(b.id+'-result');
    out.innerText = '...';
    out.style.backgroundColor = 'white';
    out.style.color = 'black';

    ping(b.id, function(res) {
      if (res['error'] != undefined) {
        out.style.backgroundColor = 'red';
        out.style.color = 'white';
        out.innerText = 'error';
        return;
      }
      out.innerText = res.took + 'ms';
    });
  };
}

document.getElementById('all').onclick = function() {
  for (let i = 0; i < buttons.length; i++) {
    buttons[i].click();
  }
};
</script>
</html>
